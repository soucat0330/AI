<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è¡Œå‹•å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  .timeline { position: relative; height: 160px; border: 1px solid rgba(255,255,255,0.06); background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding: 12px; border-radius: 10px; }
  .timeline-row { position: relative; height: 36px; margin-bottom: 8px; }
  .timeline-label { position: absolute; left: 0; top: 0; bottom: 0; width: 160px; display:flex;align-items:center;padding-left:8px;font-size:13px }
  .timeline-track { position: absolute; left: 170px; right: 12px; top: 0; bottom: 0; }
  .timeline-bar { position: absolute; height: 28px; top: 4px; border-radius: 6px; display:flex;align-items:center;padding-left:8px; font-weight:600; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
  .calendar-cell { border: 1px solid rgba(255,255,255,0.1); padding: 6px; border-radius: 6px; min-height: 60px; font-size: 12px; }
  .calendar-cell h4 { font-weight: 600; margin-bottom: 4px; font-size: 12px; }
</style>
</head>
<body class="transition-colors duration-500 min-h-screen p-6 font-sans">
  <div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">è¡Œå‹•å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</h1>
      <select id="themeSelect" class="p-2 rounded bg-gray-700 text-sm">
        <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
        <option value="light">ãƒ©ã‚¤ãƒˆ</option>
        <option value="blue">ãƒ–ãƒ«ãƒ¼</option>
        <option value="mono">ãƒ¢ãƒã‚¯ãƒ­</option>
      </select>
    </div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <div class="bg-gray-800 p-4 rounded-lg">
    <h2 class="font-semibold mb-2">ã‚¿ã‚¹ã‚¯è¿½åŠ </h2>
    <input id="title" class="w-full p-2 rounded mb-2 bg-gray-700" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
    <input id="deadline" type="datetime-local" class="w-full p-2 rounded mb-2 bg-gray-700" />
    <input id="genre" class="w-full p-2 rounded mb-2 bg-gray-700" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«" />
    <input id="subjective" type="number" class="w-full p-2 rounded mb-2 bg-gray-700" placeholder="ä¸»è¦³çš„é‡è¦åº¦(1-10)" />
    <input id="objective" type="number" class="w-full p-2 rounded mb-2 bg-gray-700" placeholder="å®¢è¦³çš„é‡è¦åº¦(1-10)" />
    <input id="duration" type="number" class="w-full p-2 rounded mb-2 bg-gray-700" placeholder="è¦‹ç©æ™‚é–“(åˆ†)" />
    <button id="addTask" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded font-semibold">è¿½åŠ </button>

    <div class="bg-gray-800 p-4 rounded-lg mt-4">
      <h2 class="font-semibold mb-2">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
      <div id="taskList" class="space-y-2"></div>
    </div>
  </div>

  <div class="col-span-2 bg-gray-800 p-4 rounded-lg">
    <h2 class="font-semibold mb-2">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ</h2>
    <div class="flex gap-2 mb-3">
      <input id="date" type="date" class="p-2 rounded bg-gray-700" />
      <button id="generate" class="bg-green-600 hover:bg-green-500 py-2 px-4 rounded font-semibold">ç”Ÿæˆ</button>
    </div>

    <div id="scheduleList" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4"></div>

    <div>
      <h3 class="font-medium mb-2">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
      <div id="timeline" class="timeline"></div>
    </div>

    <div class="mt-6">
      <h3 class="font-medium mb-2">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
      <div id="calendar" class="calendar-grid"></div>
    </div>
  </div>
</div>

<div class="bg-gray-800 p-4 rounded-lg mt-4">
  <h2 class="font-semibold mb-2">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
    <select id="feedbackTask" class="col-span-2 p-2 rounded bg-gray-700"></select>
    <input id="actualDuration" type="number" placeholder="å®Ÿç¸¾æ™‚é–“(åˆ†)" class="p-2 rounded bg-gray-700" />
    <select id="completed" class="p-2 rounded bg-gray-700"><option value="1">å®Œäº†ã—ãŸ</option><option value="0">æœªå®Œäº†</option></select>
  </div>
  <div class="mt-3">
    <button id="saveFeedback" class="bg-yellow-500 hover:bg-yellow-400 py-2 px-4 rounded font-semibold">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜</button>
  </div>
</div>

  </div>

<script>
const STORAGE_KEY = 'behavior_scheduler_db_v3';
let db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"tasks":[],"records":[],"theme":"dark"}');

const titleEl = document.getElementById('title');
const deadlineEl = document.getElementById('deadline');
const genreEl = document.getElementById('genre');
const subjectiveEl = document.getElementById('subjective');
const objectiveEl = document.getElementById('objective');
const durationEl = document.getElementById('duration');
const addBtn = document.getElementById('addTask');
const generateBtn = document.getElementById('generate');
const scheduleList = document.getElementById('scheduleList');
const timelineRoot = document.getElementById('timeline');
const feedbackTaskEl = document.getElementById('feedbackTask');
const actualDurationEl = document.getElementById('actualDuration');
const completedEl = document.getElementById('completed');
const saveFeedbackBtn = document.getElementById('saveFeedback');
const taskListEl = document.getElementById('taskList');
const themeSelect = document.getElementById('themeSelect');
const calendarEl = document.getElementById('calendar');

function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

function renderTasksInFeedback(){
  feedbackTaskEl.innerHTML = '';
  if(!db.tasks.length){
    feedbackTaskEl.innerHTML = '<option value="">ï¼ˆã‚¿ã‚¹ã‚¯ãªã—ï¼‰</option>';
    return;
  }
  db.tasks.forEach((t,i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = t.title;
    feedbackTaskEl.appendChild(opt);
  });
}

function renderTaskList(){
  taskListEl.innerHTML = '';
  if(!db.tasks.length){
    taskListEl.innerHTML = '<div class="text-gray-400 text-sm">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  db.tasks.forEach((t,i)=>{
    const card = document.createElement('div');
    card.className = 'p-3 bg-gray-700 rounded flex justify-between items-center';
    const info = document.createElement('div');
    info.innerHTML = `<div class="font-semibold">${escapeHtml(t.title)}</div>
      <div class="text-sm text-gray-300">æœŸé™: ${t.deadline || 'æœªè¨­å®š'} / ã‚¸ãƒ£ãƒ³ãƒ«: ${t.genre}</div>`;
    const del = document.createElement('button');
    del.textContent='å‰Šé™¤';
    del.className='bg-red-600 hover:bg-red-500 px-2 py-1 rounded text-sm';
    del.onclick=()=>{db.tasks.splice(i,1);saveDB();renderTaskList();renderTasksInFeedback();renderCalendar();}
    card.append(info,del);
    taskListEl.appendChild(card);
  });
}

addBtn.onclick=()=>{
  const t={
    title:titleEl.value.trim(),
    deadline:deadlineEl.value||'',
    genre:genreEl.value.trim()||'æœªè¨­å®š',
    subjective:+subjectiveEl.value||5,
    objective:+objectiveEl.value||5,
    duration:+durationEl.value||30
  };
  if(!t.title) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›');
  db.tasks.push(t);
  db.records.push({task:t,completed:0,actualDuration:null});
  saveDB();
  titleEl.value=deadlineEl.value=genreEl.value=subjectiveEl.value=objectiveEl.value=durationEl.value='';
  renderTaskList();renderTasksInFeedback();renderCalendar();
};

function featurize(t){return [(t.subjective||0)/10,(t.objective||0)/10,Math.log(1+(t.duration||30))/Math.log(241)];}
let model=null;
async function trainModel(records){
  const data=records.filter(r=>r.task);
  if(!data.length) return;
  const xs=tf.tensor2d(data.map(d=>featurize(d.task)));
  const ys=tf.tensor2d(data.map(d=>[d.completed?1:0]));
  model=tf.sequential();
  model.add(tf.layers.dense({inputShape:[3],units:8,activation:'relu'}));
  model.add(tf.layers.dense({units:4,activation:'relu'}));
  model.add(tf.layers.dense({units:1,activation:'sigmoid'}));
  model.compile({optimizer:'adam',loss:'binaryCrossentropy'});
  await model.fit(xs,ys,{epochs:15,batchSize:8});
  xs.dispose();ys.dispose();
}

generateBtn.onclick=async()=>{
  if(!db.tasks.length) return alert('ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
  if(!model && db.records.length) await trainModel(db.records);
  const scored=await Promise.all(db.tasks.map(async t=>{
    if(model){const v=tf.tensor2d([featurize(t)]);const p=(await model.predict(v).data())[0];v.dispose();return {...t,score:p};}
    return {...t,score:Math.random()*0.5+0.25};
  }));
  scored.sort((a,b)=>b.score-a.score);
  scheduleList.innerHTML='';
  scored.forEach(s=>{
    const c=document.createElement('div');c.className='p-3 bg-gray-700 rounded';
    c.innerHTML=`<div class="font-semibold">${s.title}</div>
      <div class="text-sm">å„ªå…ˆåº¦: ${(s.score*100).toFixed(1)}%</div>`;
    scheduleList.appendChild(c);
  });
  renderTimeline(scored);
  renderCalendar();
  db.records.push(...scored.map(s=>({task:s,completed:0,actualDuration:null})));
  saveDB();
};

function renderTimeline(tasks){
  timelineRoot.innerHTML='';
  const total=tasks.reduce((a,b)=>a+(b.duration||30),0);
  let cur=0;
  tasks.forEach(t=>{
    const r=document.createElement('div');r.className='timeline-row';
    const l=document.createElement('div');l.className='timeline-label';l.textContent=t.title;
    const tr=document.createElement('div');tr.className='timeline-track';
    const b=document.createElement('div');b.className='timeline-bar';
    b.style.left=(cur/total)*100+'%';b.style.width=((t.duration||30)/total)*100+'%';
    const hue=Math.round(200-(t.score||0)*120);
    b.style.background=`hsl(${hue} 90% 65%)`;b.textContent=`${t.duration}m`;
    tr.appendChild(b);r.append(l,tr);timelineRoot.appendChild(r);cur+=t.duration;
  });
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
function renderCalendar(){
  calendarEl.innerHTML='';
  const now=new Date();
  const year=now.getFullYear(),month=now.getMonth();
  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);
  const startDay=first.getDay(),days=last.getDate();
  for(let i=0;i<startDay;i++) calendarEl.appendChild(document.createElement('div'));
  for(let d=1;d<=days;d++){
    const cell=document.createElement('div');cell.className='calendar-cell';
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    cell.innerHTML=`<h4>${d}</h4>`;
    const todaysTasks=db.tasks.filter(t=>t.deadline.startsWith(dateStr));
    todaysTasks.forEach(t=>{
      const item=document.createElement('div');
      item.textContent='â€¢ '+t.title;
      item.className='text-xs truncate';
      cell.appendChild(item);
    });
    calendarEl.appendChild(cell);
  }
}

// ãƒ†ãƒ¼ãƒåˆ‡æ›¿
function applyTheme(th){
  const b=document.body;
  b.classList.remove('dark','light','blue','mono');
  if(th==='light'){b.className='bg-gray-100 text-gray-900';}
  else if(th==='blue'){b.className='bg-blue-950 text-blue-100';}
  else if(th==='mono'){b.className='bg-gray-200 text-gray-800';}
  else{b.className='bg-gray-900 text-gray-100';}
  db.theme=th;saveDB();
}
themeSelect.onchange=()=>applyTheme(themeSelect.value);

saveFeedbackBtn.onclick=async()=>{
  const idx=+feedbackTaskEl.value;
  if(isNaN(idx)||!db.tasks[idx]) return alert('é¸æŠã—ã¦ãã ã•ã„');
  const dur=+actualDurationEl.value||db.tasks[idx].duration;
  const comp=+completedEl.value||0;
  db.records.push({task:db.tasks[idx],actualDuration:dur,completed:comp});
  await trainModel(db.records);
  saveDB();alert('ä¿å­˜ã—ã¾ã—ãŸ');
};

applyTheme(db.theme);
themeSelect.value=db.theme;
renderTaskList();renderTasksInFeedback();renderCalendar();
</script>

</body>
</html>
