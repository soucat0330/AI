<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Planner - Complete Prototype</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --accent: #F472B6;
            --bg: #F3F4F6;
            --card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --success: #10B981;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Phone Frame */
        .phone-frame {
            width: 100%;
            max-width: 400px;
            background: var(--bg); /* èƒŒæ™¯è‰²ã¨åˆã‚ã›ã‚‹ */
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
            max-height: 850px;
            border: 8px solid #111;
        }

        /* Header */
        header {
            padding: 20px 24px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            z-index: 10;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .current-time-display { font-size: 0.9rem; font-weight: 600; color: var(--text-sub); }

        /* Timeline */
        .timeline-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            scrollbar-width: none; /* Firefox */
        }
        .timeline-container::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

        /* Tasks */
        .task {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
            border-left: 4px solid transparent;
        }
        .task.priority-high { border-left-color: var(--danger); }
        .task.priority-normal { border-left-color: var(--primary); }
        .task.priority-low { border-left-color: var(--success); }
        .task.priority-fixed { border-left-color: var(--text-sub); background: #F9FAFB; }

        .task.is-active {
            background: #EEF2FF;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.15);
        }
        .task.will-remove { opacity: 0.4; text-decoration: line-through; transform: scale(0.95); }
        .task.will-change { animation: pulseHighlight 1.5s infinite; }

        @keyframes pulseHighlight {
            0% { background: var(--card); }
            50% { background: #FEF3C7; }
            100% { background: var(--card); }
        }

        .time-col { font-size: 0.75rem; color: var(--text-sub); text-align: right; min-width: 45px; }
        .info-col { flex: 1; }
        .task-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
        .task-meta { font-size: 0.75rem; color: var(--text-sub); display: flex; gap: 8px; align-items: center;}
        .tag { padding: 2px 6px; background: #F3F4F6; border-radius: 4px; }

        /* Bottom FABs */
        .fab-container {
            position: absolute;
            bottom: 30px;
            left: 24px;
            right: 24px;
            display: flex;
            justify-content: space-between;
            z-index: 20;
            pointer-events: none; /* ãƒœã‚¿ãƒ³ä»¥å¤–ã¯ã‚¯ãƒªãƒƒã‚¯é€é */
        }
        .fab-btn {
            pointer-events: auto;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }
        .btn-ai { background: var(--text-main); }
        .btn-add { background: var(--primary); }

        /* Modals (Overlays) */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 50;
            display: none; /* åˆæœŸéè¡¨ç¤º */
            align-items: flex-end; /* ä¸‹ã‹ã‚‰å‡ºã™ */
        }
        .modal-overlay.active { display: flex; }

        .modal-panel {
            width: 100%;
            background: #fff;
            border-radius: 30px 30px 0 0;
            padding: 30px 24px 40px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            animation: slideUp 0.3s ease-out;
            box-sizing: border-box;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .close-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-sub); cursor: pointer; }

        /* Input Form Styles */
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text-sub); }
        .input-field {
            width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px;
            font-size: 1rem; outline: none; transition: border-color 0.3s; box-sizing: border-box;
        }
        .input-field:focus { border-color: var(--primary); }
        .select-row { display: flex; gap: 12px; }
        .btn-block {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer;
        }

        /* AI Feedback Styles (from v2) */
        .ai-header-content { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .ai-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #a855f7); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
        .ai-message { font-size: 1.1rem; font-weight: 700; line-height: 1.4; }
        .feedback-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .feedback-option {
            background: #F9FAFB; border: 2px solid transparent; padding: 16px;
            border-radius: 16px; text-align: center; cursor: pointer; transition: all 0.2s;
        }
        .feedback-option:hover { background: #EEF2FF; border-color: #C7D2FE; }
        .emoji { font-size: 1.5rem; display: block; margin-bottom: 8px; }
        .label { font-size: 0.85rem; font-weight: 600; }
        .proposal-card { background: #FFFBEB; border: 1px solid #FCD34D; border-radius: 12px; padding: 16px; margin-top: 20px; font-size: 0.9rem; }
        .proposal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-accept { flex: 1; padding: 12px; background: var(--text-main); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .btn-cancel { padding: 12px 20px; background: transparent; color: var(--text-sub); border: none; cursor: pointer; }

    </style>
</head>
<body>

<div class="phone-frame">
    <header>
        <h1>Fluid Planner</h1>
        <div class="current-time-display" id="currentTimeDisplay">13:00 Now</div>
    </header>

    <div class="timeline-container" id="timeline">
        </div>

    <div class="fab-container">
        <button class="fab-btn btn-ai" onclick="openAIModal()">âœ¨</button>
        <button class="fab-btn btn-add" onclick="openAddTaskModal()">â•</button>
    </div>

    <div class="modal-overlay" id="addTaskModal">
        <div class="modal-panel">
            <div class="modal-header">
                <span>æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </span>
                <button class="close-btn" onclick="closeModal('addTaskModal')">âœ•</button>
            </div>
            <div class="input-group">
                <label class="input-label">ã‚¿ã‚¹ã‚¯å</label>
                <input type="text" id="taskTitleInput" class="input-field" placeholder="ä¾‹: ä¼ç”»æ›¸ä½œæˆ">
            </div>
            <div class="select-row input-group">
                <div style="flex:1">
                    <label class="input-label">æ‰€è¦æ™‚é–“</label>
                    <select id="taskDurationInput" class="input-field">
                        <option value="15">15åˆ†</option>
                        <option value="30" selected>30åˆ†</option>
                        <option value="45">45åˆ†</option>
                        <option value="60">60åˆ†</option>
                        <option value="90">90åˆ†</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label class="input-label">å„ªå…ˆåº¦ (AIãŒè€ƒæ…®ã—ã¾ã™)</label>
                    <select id="taskPriorityInput" class="input-field">
                        <option value="high">âš¡ é«˜ (å‰²ã‚Šè¾¼ã¿)</option>
                        <option value="normal" selected>é€šå¸¸</option>
                        <option value="low">ä½ (å¾Œå›ã—OK)</option>
                    </select>
                </div>
            </div>
            <button class="btn-block" onclick="addNewTask()">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¿½åŠ </button>
        </div>
    </div>

    <div class="modal-overlay" id="aiModal">
        <div class="modal-panel">
            <div class="ai-header-content">
                <div class="ai-avatar">ğŸ¤–</div>
                <div class="ai-message" id="aiMessage">ä»Šã®çŠ¶æ³ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚<br>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª¿æ•´ã—ã¾ã™ã€‚</div>
            </div>

            <div class="feedback-grid" id="feedbackOptions">
                <div class="feedback-option" onclick="generateProposal('stuck')">
                    <span class="emoji">ğŸŒ</span><span class="label">æ™‚é–“ãŒã‹ã‹ã£ã¦ã‚‹</span>
                </div>
                <div class="feedback-option" onclick="generateProposal('tired')">
                    <span class="emoji">ğŸ˜«</span><span class="label">ç–²ã‚ŒãŸãƒ»ä¼‘æ†©ã—ãŸã„</span>
                </div>
                <div class="feedback-option" onclick="generateProposal('done')">
                    <span class="emoji">âœ…</span><span class="label">å®Œäº†ï¼æ¬¡ã¸</span>
                </div>
                 </div>

            <div id="proposalArea" style="display:none;">
                <div class="proposal-card" id="proposalText"></div>
                <div class="proposal-actions">
                    <button class="btn-cancel" onclick="resetAIModal()">æˆ»ã‚‹</button>
                    <button class="btn-accept" onclick="applyProposal()">å¤‰æ›´ã‚’é©ç”¨</button>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal('aiModal')" style="position:absolute; top:20px; right:24px;">âœ•</button>
        </div>
    </div>
</div>

<script>
    // ================= State Management =================
    let tasks = [
        { id: 1, title: "ãƒãƒ¼ãƒ MTG", duration: 30, priority: "fixed", type: "meeting" },
        { id: 2, title: "ä¼ç”»æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ", duration: 60, priority: "high", type: "work" },
        { id: 3, title: "ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯", duration: 30, priority: "low", type: "admin" },
        { id: 4, title: "ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼", duration: 45, priority: "normal", type: "creative" }
    ];

    // ã‚¢ãƒ—ãƒªã®ç¾åœ¨æ™‚åˆ»ï¼ˆãƒ‡ãƒ¢ç”¨å›ºå®šè¨­å®šï¼‰
    let currentAppTime = new Date();
    currentAppTime.setHours(13, 0, 0, 0);

    let pendingProposalTasks = null; // ææ¡ˆé©ç”¨å¾…ã¡ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ

    // ================= Core Logic: Scheduler & Renderer =================

    /**
     * ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®—ã®æ ¸ã¨ãªã‚‹é–¢æ•°ã€‚
     * ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€å„ªå…ˆåº¦ã§ä¸¦ã³æ›¿ãˆã€æ™‚é–“ã‚’å‰²ã‚Šå½“ã¦ã¦è¿”ã™ã€‚
     * @param {Array} taskList è¨ˆç®—å¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
     * @param {Date} startTime é–‹å§‹æ™‚é–“
     * @param {boolean} skipSort ã™ã§ã«ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®å ´åˆï¼ˆAIææ¡ˆæ™‚ãªã©ï¼‰ã¯true
     */
    function calculateSchedule(taskList, startTime, skipSort = false) {
        let calculatedTasks = [...taskList]; // ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ

        if (!skipSort) {
            // 1. å›ºå®š(fixed)ã‚¿ã‚¹ã‚¯ã¨ãã‚Œä»¥å¤–ã‚’åˆ†ã‘ã‚‹
            const fixedTasks = calculatedTasks.filter(t => t.priority === 'fixed');
            let movableTasks = calculatedTasks.filter(t => t.priority !== 'fixed');

            // 2. å‹•ã‹ã›ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ (high > normal > low)
            const score = p => p === 'high' ? 3 : (p === 'normal' ? 2 : 1);
            movableTasks.sort((a, b) => score(b.priority) - score(a.priority));

            // 3. å†çµåˆï¼ˆå˜ç´”åŒ–ã®ãŸã‚ã€å›ºå®šã‚¿ã‚¹ã‚¯ã®å¾Œã«å‹•çš„ã‚¿ã‚¹ã‚¯ã‚’ç¹‹ã’ã‚‹ï¼‰
            // â€»å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã§ã¯ã€å›ºå®šã‚¿ã‚¹ã‚¯ã®ã€Œåˆé–“ã€ã«å‹•çš„ã‚¿ã‚¹ã‚¯ã‚’åŸ‹ã‚ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã ãŒã€
            // ã“ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ã€Œå›ºå®šã‚¿ã‚¹ã‚¯ã‚’å…ˆã«ã“ãªã—ã€ãã®å¾Œå„ªå…ˆåº¦é †ã€ã¨ã™ã‚‹ã€‚
            calculatedTasks = [...fixedTasks, ...movableTasks];
        }

        // 4. æ™‚é–“å‰²ã‚Šå½“ã¦
        let timeCursor = new Date(startTime);
        calculatedTasks.forEach(task => {
            if (task.removed) return; // å‰Šé™¤äºˆå®šã®ã‚¿ã‚¹ã‚¯ã¯æ™‚é–“è¨ˆç®—ã‹ã‚‰é™¤å¤–
            task.start = new Date(timeCursor);
            timeCursor.setMinutes(timeCursor.getMinutes() + task.duration);
            task.end = new Date(timeCursor);
        });

        return calculatedTasks;
    }

    /**
     * ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æç”»ã™ã‚‹ã€‚
     * @param {Array} taskList æç”»ã™ã‚‹ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼ˆè¨ˆç®—æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ï¼‰
     * @param {Object} previewOptions ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ { highlightIds: [], dimOthers: bool }
     */
    function renderTimeline(taskList, previewOptions = {}) {
        const container = document.getElementById('timeline');
        container.innerHTML = '';

        const { highlightIds = [], dimOthers = false } = previewOptions;

        taskList.forEach((task, index) => {
            if (task.removed && !previewOptions.showRemoved) return; // é€šå¸¸ã¯å‰Šé™¤æ¸ˆã¿ã‚’è¡¨ç¤ºã—ãªã„

            const isActive = index === 0 && !task.removed;
            let className = `task priority-${task.priority}`;
            if (isActive) className += ' is-active';
            if (task.removed) className += ' will-remove';
            if (highlightIds.includes(task.id)) className += ' will-change';
            if (dimOthers && !highlightIds.includes(task.id) && !task.removed) className += ' style="opacity:0.6;"'; // å¤‰æ›´ä»¥å¤–ã‚’è–„ã

            const div = document.createElement('div');
            div.className = className;
            if (dimOthers && !highlightIds.includes(task.id) && !task.removed) div.style.opacity = '0.6';

            div.innerHTML = `
                <div class="time-col">
                    <div>${formatTime(task.start)}</div>
                    <div style="opacity:0.6">${formatTime(task.end)}</div>
                </div>
                <div class="info-col">
                    <div class="task-title">${task.title} ${task.priority === 'fixed' ? 'ğŸ”’' : ''}</div>
                    <div class="task-meta">
                        <span class="tag">â± ${task.duration}åˆ†</span>
                        ${task.type ? `<span class="tag">${task.type}</span>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
        updateCurrentTimeDisplay();
    }


    // ================= Feature: Add Task =================

    function addNewTask() {
        const titleInput = document.getElementById('taskTitleInput');
        const durationInput = document.getElementById('taskDurationInput');
        const priorityInput = document.getElementById('taskPriorityInput');

        if (!titleInput.value) { alert("ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        const newTask = {
            id: Date.now(),
            title: titleInput.value,
            duration: parseInt(durationInput.value),
            priority: priorityInput.value,
            type: 'general' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒ—
        };

        // ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
        tasks.push(newTask);

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†è¨ˆç®—ã¨æç”»
        const calculatedTasks = calculateSchedule(tasks, currentAppTime);
        tasks = calculatedTasks; // ã‚½ãƒ¼ãƒˆçµæœã‚’æ­£ã¨ã™ã‚‹
        renderTimeline(tasks);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒªã‚»ãƒƒãƒˆ
        closeModal('addTaskModal');
        titleInput.value = '';
    }


    // ================= Feature: AI Feedback & Proposal =================

    function generateProposal(type) {
        const aiMessageEl = document.getElementById('aiMessage');
        const optionsEl = document.getElementById('feedbackOptions');
        const proposalAreaEl = document.getElementById('proposalArea');
        const proposalTextEl = document.getElementById('proposalText');

        // UIåˆ‡ã‚Šæ›¿ãˆ (æ€è€ƒä¸­...)
        optionsEl.style.display = 'none';
        proposalAreaEl.style.display = 'block';
        aiMessageEl.innerText = "AIãŒæœ€é©åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨ˆç®—ä¸­...";
        proposalTextEl.innerHTML = '<div style="text-align:center; color:#999;">è¨ˆç®—ã—ã¦ã„ã¾ã™...</div>';

        // æ“¬ä¼¼çš„ãªè¨ˆç®—é…å»¶
        setTimeout(() => {
            let tempTasks = JSON.parse(JSON.stringify(tasks)); // ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
            let message = "";
            let proposalHtml = "";
            let highlightIds = [];

            if (tempTasks.length === 0) {
               aiMessageEl.innerText = "ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
               proposalTextEl.innerHTML = "ã¾ãšã¯ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
               return;
            }
            
            const currentTask = tempTasks[0];

            switch(type) {
                case 'stuck': // æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã‚‹
                    message = "é›£èˆªã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚è¨ˆç”»ã‚’ä¿®æ­£ã—ã¾ã™ã€‚";
                    // 1. ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã‚’å»¶é•·
                    currentTask.duration += 30;
                    highlightIds.push(currentTask.id);
                    
                    // 2. (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) ä½å„ªå…ˆåº¦ã‚’å‰Šé™¤å€™è£œã«ã™ã‚‹
                    const lowPriIndex = tempTasks.findIndex(t => t.priority === 'low' && t.id !== currentTask.id);
                    if(lowPriIndex > -1) {
                        tempTasks[lowPriIndex].removed = true;
                        highlightIds.push(tempTasks[lowPriIndex].id);
                        proposalHtml = `<strong>ææ¡ˆ:</strong><br>ã€Œ${currentTask.title}ã€ã‚’30åˆ†å»¶é•·ã—ã¾ã™ã€‚<br>æ™‚é–“ã®å¸³å°»ã‚’åˆã‚ã›ã‚‹ãŸã‚ã€ä½å„ªå…ˆã®ã€Œ${tempTasks[lowPriIndex].title}ã€ã‚’æœ¬æ—¥ã®äºˆå®šã‹ã‚‰å¤–ã—ã¾ã™ã€‚`;
                    } else {
                        proposalHtml = `<strong>ææ¡ˆ:</strong><br>ã€Œ${currentTask.title}ã€ã‚’30åˆ†å»¶é•·ã—ã¾ã™ã€‚<br>å¾Œç¶šã®ã‚¿ã‚¹ã‚¯ã¯ã™ã¹ã¦é †å»¶ã•ã‚Œã¾ã™ã€‚`;
                    }
                    break;

                case 'tired': // ç–²ã‚ŒãŸ
                    message = "ãŠç–²ã‚Œæ§˜ã§ã™ã€‚å°‘ã—ä¼‘æ†©ã‚’æŒŸã¿ã¾ã—ã‚‡ã†ã€‚";
                    const breakTask = { id: Date.now(), title: "â˜•ï¸ ä¼‘æ†©", duration: 15, priority: "fixed", type: "break" };
                    // ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã®æ¬¡ã«ä¼‘æ†©ã‚’æŒ¿å…¥
                    tempTasks.splice(1, 0, breakTask);
                    highlightIds.push(breakTask.id);
                    proposalHtml = `<strong>ææ¡ˆ:</strong><br>æ¬¡ã®ã‚¿ã‚¹ã‚¯ã®å‰ã«ã€15åˆ†ã®ä¼‘æ†©æ™‚é–“ã‚’ç¢ºä¿ã—ã¾ã—ãŸã€‚ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã—ã‚‡ã†ã€‚`;
                    break;

                case 'done': // å®Œäº†
                    message = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼æ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸é€²ã¿ã¾ã™ã€‚";
                    tempTasks[0].removed = true; // ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†æ‰±ã„
                    highlightIds.push(tempTasks[0].id);
                     proposalHtml = `<strong>ææ¡ˆ:</strong><br>ã€Œ${currentTask.title}ã€ã‚’å®Œäº†ã¨ã—ã¾ã™ã€‚<br>æº–å‚™ãŒã§ãæ¬¡ç¬¬ã€æ¬¡ã®ã‚¿ã‚¹ã‚¯ã«å–ã‚Šæ›ã‹ã‚Šã¾ã—ã‚‡ã†ã€‚`;
                    // â€»æœ¬æ¥ã¯ã“ã“ã§currentAppTimeã‚’é€²ã‚ã‚‹å‡¦ç†ãŒå…¥ã‚‹ãŒã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã®ã§æ®ãˆç½®ã
                    break;
            }

            // ææ¡ˆç”¨ã«å†è¨ˆç®—ï¼ˆã‚½ãƒ¼ãƒˆã¯ã—ãªã„ã€ä»Šã®ä¸¦ã³ã‚’ç¶­æŒã—ã¦å¤‰æ›´ã‚’é©ç”¨ï¼‰
            pendingProposalTasks = calculateSchedule(tempTasks, currentAppTime, true);

            // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
            aiMessageEl.innerText = message;
            proposalTextEl.innerHTML = proposalHtml;

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆå¤‰æ›´ç®‡æ‰€ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã€å‰Šé™¤äºˆå®šã‚‚è¡¨ç¤ºï¼‰
            renderTimeline(pendingProposalTasks, { highlightIds: highlightIds, showRemoved: true, dimOthers: true });

        }, 800);
    }

    // ææ¡ˆã‚’é©ç”¨ã™ã‚‹
    function applyProposal() {
        if (pendingProposalTasks) {
            // å®Œäº†(removed)ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰ç‰©ç†çš„ã«å‰Šé™¤
            tasks = pendingProposalTasks.filter(t => !t.removed);
            
            // ã‚‚ã—å…ˆé ­ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦å‰Šé™¤ã•ã‚Œã¦ã„ãŸã‚‰ã€æ™‚é–“ãŒé€²ã‚“ã ã“ã¨ã«ã™ã‚‹ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
            if(pendingProposalTasks[0] && pendingProposalTasks[0].removed) {
                 // æ¬¡ã®ã‚¿ã‚¹ã‚¯ã®é–‹å§‹äºˆå®šæ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã¨ã™ã‚‹
                 if(tasks.length > 0) {
                     currentAppTime = new Date(tasks[0].start);
                 }
            }

            // æ­£å¼ã«å†è¨ˆç®—ã—ã¦æç”»
            tasks = calculateSchedule(tasks, currentAppTime);
            renderTimeline(tasks);
            
            closeModal('aiModal');
            pendingProposalTasks = null;
        }
    }

    // AIãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
    function resetAIModal() {
        document.getElementById('feedbackOptions').style.display = 'grid';
        document.getElementById('proposalArea').style.display = 'none';
        document.getElementById('aiMessage').innerHTML = 'ä»Šã®çŠ¶æ³ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚<br>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª¿æ•´ã—ã¾ã™ã€‚';
        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç¾è¡Œã«æˆ»ã™
        renderTimeline(tasks);
    }


    // ================= UI Helpers =================
    function openModal(id) {
        document.getElementById(id).classList.add('active');
        if(id === 'aiModal') resetAIModal();
    }
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        if(id === 'aiModal') resetAIModal(); // é–‰ã˜ã‚‹æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æˆ»ã™
    }
    // å„FABãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    function openAddTaskModal() { openModal('addTaskModal'); }
    function openAIModal() { openModal('aiModal'); }

    function formatTime(date) {
        return date ? date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '--:--';
    }
    function updateCurrentTimeDisplay() {
        document.getElementById('currentTimeDisplay').innerText = `${formatTime(currentAppTime)} Now`;
    }


    // ================= Initial Render =================
    // åˆæœŸãƒ‡ãƒ¼ã‚¿ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®—ã—ã¦æç”»
    tasks = calculateSchedule(tasks, currentAppTime);
    renderTimeline(tasks);

</script>

</body>
</html>
